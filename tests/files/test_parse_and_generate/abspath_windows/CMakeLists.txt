cmake_minimum_required(VERSION 3.13)

project(openssl C CXX)
enable_language(ASM_NASM)
enable_language(RC)

list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_LIST_DIR})
include(extensions)

set(OPENSSL_SOURCE_DIR "${CMAKE_CURRENT_LIST_DIR}" CACHE PATH "")
set(CMAKE_ASM_NASM_OBJECT_FORMAT win32)
file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/crypto/include)

set(copy_prebuilt_artifacts_DIR prebuilt)
set(copy_prebuilt_artifacts_DEST ${CMAKE_CURRENT_BINARY_DIR})
file(GLOB_RECURSE _files RELATIVE ${CMAKE_CURRENT_LIST_DIR}/${copy_prebuilt_artifacts_DIR} ${copy_prebuilt_artifacts_DIR}/*)
foreach(_f ${_files})
    configure_file(${copy_prebuilt_artifacts_DIR}/${_f} ${copy_prebuilt_artifacts_DEST}/${_f} COPYONLY)
endforeach()
file(MAKE_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/ssl)

set_source_files_properties(${OPENSSL_SOURCE_DIR}/crypto/dllmain.c PROPERTIES COMPILE_OPTIONS
    "/Gs0;/GF;/Gy;/MT$<$<CONFIG:Debug>:d>;/W3;/wd4090;/guard:cf;/bigobj;/GL;-Zc:threadSafeInit-;-Gw;-Oy-;-DL_ENDIAN;-DOPENSSL_PIC;-DOPENSSL_CPUID_OBJ;-DOPENSSL_BN_ASM_PART_WORDS;-DOPENSSL_IA32_SSE2;-DOPENSSL_BN_ASM_MONT;-DOPENSSL_BN_ASM_GF2m;-DSHA1_ASM;-DSHA256_ASM;-DSHA512_ASM;-DRC4_ASM;-DMD5_ASM;-DRMD160_ASM;-DAES_ASM;-DVPAES_ASM;-DWHIRLPOOL_ASM;-DGHASH_ASM;-DECP_NISTZ256_ASM;-DPADLOCK_ASM;-DPOLY1305_ASM;-DOPENSSLDIR=\"C:\\\\openssl\";-DENGINESDIR=\"D:\\\\src\\\\3rd_party_gen\\\\.build_win\\\\externals\\\\openssl\\\\1.1.1\\\\openssl_package\\\\lib\\\\engines-1_1\";-DOPENSSL_SYS_WIN32;-DWIN32_LEAN_AND_MEAN;-DUNICODE;-D_UNICODE;-D_CRT_SECURE_NO_DEPRECATE;-D_WINSOCK_DEPRECATED_NO_WARNINGS;-DOPENSSL_USE_APPLINK;-D_WIN32_WINNT=0x0501"
)
set_source_files_properties(${OPENSSL_SOURCE_DIR}/crypto/dllmain.c PROPERTIES INCLUDE_DIRECTORIES
    "${CMAKE_CURRENT_BINARY_DIR};${CMAKE_CURRENT_BINARY_DIR}/crypto/include;${CMAKE_CURRENT_BINARY_DIR}/include;${OPENSSL_SOURCE_DIR};${OPENSSL_SOURCE_DIR}/crypto/include;${OPENSSL_SOURCE_DIR}/include"
)
set_source_files_properties(${OPENSSL_SOURCE_DIR}/initialize.cpp PROPERTIES COMPILE_OPTIONS
    "/Gs0;/GF;/Gy;/MT$<$<CONFIG:Debug>:d>;/W3;/wd4090;/guard:cf;/bigobj;/GL;-Zc:threadSafeInit-;-Gw;-Oy-;-DL_ENDIAN;-DOPENSSL_PIC;-DOPENSSL_CPUID_OBJ;-DOPENSSL_BN_ASM_PART_WORDS;-DOPENSSL_IA32_SSE2;-DOPENSSL_BN_ASM_MONT;-DOPENSSL_BN_ASM_GF2m;-DSHA1_ASM;-DSHA256_ASM;-DSHA512_ASM;-DRC4_ASM;-DMD5_ASM;-DRMD160_ASM;-DAES_ASM;-DVPAES_ASM;-DWHIRLPOOL_ASM;-DGHASH_ASM;-DECP_NISTZ256_ASM;-DPADLOCK_ASM;-DPOLY1305_ASM;-DOPENSSLDIR=\"C:\\\\openssl\";-DENGINESDIR=\"D:\\\\src\\\\3rd_party_gen\\\\.build_win\\\\externals\\\\openssl\\\\1.1.1\\\\openssl_package\\\\lib\\\\engines-1_1\";-DOPENSSL_SYS_WIN32;-DWIN32_LEAN_AND_MEAN;-DUNICODE;-D_UNICODE;-D_CRT_SECURE_NO_DEPRECATE;-D_WINSOCK_DEPRECATED_NO_WARNINGS;-DOPENSSL_USE_APPLINK;-D_WIN32_WINNT=0x0501"
)
set_source_files_properties(${OPENSSL_SOURCE_DIR}/initialize.cpp PROPERTIES INCLUDE_DIRECTORIES
    "${CMAKE_CURRENT_BINARY_DIR};${CMAKE_CURRENT_BINARY_DIR}/crypto/include;${CMAKE_CURRENT_BINARY_DIR}/include;${OPENSSL_SOURCE_DIR};${OPENSSL_SOURCE_DIR}/crypto/include;${OPENSSL_SOURCE_DIR}/include"
)
set_source_files_properties(${OPENSSL_SOURCE_DIR}/ssl/tls_srp.c PROPERTIES COMPILE_OPTIONS
    "/Gs0;/GF;/Gy;/MT$<$<CONFIG:Debug>:d>;/W3;/wd4090;/guard:cf;/bigobj;/GL;-Zc:threadSafeInit-;-Gw;-Oy-;-DL_ENDIAN;-DOPENSSL_PIC;-DOPENSSL_CPUID_OBJ;-DOPENSSL_BN_ASM_PART_WORDS;-DOPENSSL_IA32_SSE2;-DOPENSSL_BN_ASM_MONT;-DOPENSSL_BN_ASM_GF2m;-DSHA1_ASM;-DSHA256_ASM;-DSHA512_ASM;-DRC4_ASM;-DMD5_ASM;-DRMD160_ASM;-DAES_ASM;-DVPAES_ASM;-DWHIRLPOOL_ASM;-DGHASH_ASM;-DECP_NISTZ256_ASM;-DPADLOCK_ASM;-DPOLY1305_ASM;-DOPENSSLDIR=\"C:\\\\openssl\";-DENGINESDIR=\"D:\\\\src\\\\3rd_party_gen\\\\.build_win\\\\externals\\\\openssl\\\\1.1.1\\\\openssl_package\\\\lib\\\\engines-1_1\";-DOPENSSL_SYS_WIN32;-DWIN32_LEAN_AND_MEAN;-DUNICODE;-D_UNICODE;-D_CRT_SECURE_NO_DEPRECATE;-D_WINSOCK_DEPRECATED_NO_WARNINGS;-DOPENSSL_USE_APPLINK;-D_WIN32_WINNT=0x0501"
)
set_source_files_properties(${OPENSSL_SOURCE_DIR}/ssl/tls_srp.c PROPERTIES INCLUDE_DIRECTORIES
    "${CMAKE_CURRENT_BINARY_DIR};${CMAKE_CURRENT_BINARY_DIR}/crypto/include;${CMAKE_CURRENT_BINARY_DIR}/include;${OPENSSL_SOURCE_DIR};${OPENSSL_SOURCE_DIR}/crypto/include;${OPENSSL_SOURCE_DIR}/include"
)
add_library(openssl_1_1 SHARED
    ${OPENSSL_SOURCE_DIR}/crypto/dllmain.c
    ${CMAKE_CURRENT_BINARY_DIR}/libcrypto.rc
    ${CMAKE_CURRENT_BINARY_DIR}/crypto/aes/aes-586.asm
    ${OPENSSL_SOURCE_DIR}/initialize.cpp
    ${OPENSSL_SOURCE_DIR}/ssl/tls_srp.c
)
target_link_options(openssl_1_1 PRIVATE
    /guard:cf
    /SUBSYSTEM:CONSOLE,5.01
    /def:${CMAKE_CURRENT_BINARY_DIR}/libcrypto.def
)
